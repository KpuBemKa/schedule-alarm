<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Alarm Schedule
  </title>
  <style>
   body {
    font-family: Arial, sans-serif;
    margin: 1rem;
}

@media (min-width: 920px) {
    body {
        max-width: 900px;
        margin: 1rem auto 1rem auto;
    }
}

table {
    width: 100%;
    max-width: 400px;
    border-collapse: collapse;
}

td {
    padding: 5px;
}

/* label {
    display: block;
    margin-top: 10px;
} */

input {
    box-sizing: border-box;
    width: 100%;
    padding: 8px;
    margin-top: 5px;
}

button {
    font-size: 1rem;
    font-weight: bold;
}

hr {
    margin: 1.5rem 0 1.5rem 0;
}

#scheduleTable {
    margin: 2rem 0 1rem 0;
}

.d-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.d-settings-row {
    margin-top: 1rem;
}

.d-schedule-label {
    font-size: 1.15rem;
}

.button-container {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 15px;
}

.form-select {
    padding: 0.25rem 1rem 0.25rem 1rem;
    font-size: 1rem;
}

.form-time {
    padding: 0.25rem;
    font-size: 1rem;
}

.base-button {
    padding: 0.5rem 1rem 0.5rem 1rem;
    font-size: 1rem;
    font-weight: bold;
}

.schedule-button {
    padding: 0.25rem 0.5rem 0.25rem 0.5rem;
    font-size: 1rem;
    margin-right: 1rem;
}

.delete-button {
    width: 2.25rem;
    height: 2.25rem;
    font-size: 1rem;
    font-weight: bold;
}

.top {
    display: flex;
    margin: 2rem 0 2rem 0;
}

.left {
    display: flex;
    flex-wrap: wrap;
    align-content: center;
    margin-right: auto;
}

.tabs {
    display: flex;
    border-bottom: 2px solid #ccc;
}

.tab {
    padding: 10px 20px;
    cursor: pointer;
    border: none;
    border-bottom: 2px solid transparent;
    background: none;
    font-size: 16px;
    width: 50%;
}

.tab.active {
    border-bottom: 2px solid #007bff;
    font-weight: bold;
    color: #007bff;
}

.tab-content {
    display: none;
    margin-top: 20px;
}

.tab-content.active {
    display: block;
}
  </style>
  <style>
   .c-calendar-container {
    margin: 1rem 0 0 0;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: space-evenly;
}

.c-month {
    border: 1px solid #ccc;
    padding: 10px;
    width: 250px;
}

.c-month h3 {
    text-align: center;
    margin: 5px 0 10px;
}

.c-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
}

.c-day,
.c-weekday {
    text-align: center;
    padding: 5px;
}

.c-weekday {
    font-weight: bold;
    background: #f0f0f0;
}

.c-day {
    cursor: pointer;
    border-radius: 3px;
}

.c-day:hover {
    background: #007bff;
    color: white;
}

#popup {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 2px solid #007bff;
    padding: 20px;
    display: none;
    z-index: 9999;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
}

#popup button {
    margin-top: 10px;
}
  </style>
 </head>
 <body>
  <div class="top">
   <div class="left">
    <span id="timeDisplay" style="font-weight: bold;">
     Loading...
    </span>
   </div>
  </div>
  <div>
   <div class="tabs">
    <button class="tab active" onclick="showTab('schedule')">
     Schedule
    </button>
    <button class="tab" onclick="showTab('settings')">
     Settings
    </button>
   </div>
   <div class="tab-content active" id="schedule">
    <form id="alarmForm">
     <div class="d-row">
      <label class="d-schedule-label" for="schedule_loop_type">
       Schedule loops:
      </label>
      <select class="form-select" name="schedule_loop_type" required="">
       <option value="daily">
        Daily
       </option>
       <option value="weekly">
        Weekly
       </option>
       <option value="monthly">
        Monthly
       </option>
       <option value="yearly">
        Yearly
       </option>
       <option value="custom">
        Custom range
       </option>
      </select>
     </div>
     <table id="scheduleTable">
      <tbody>
       <div class="d-year-view">
        <div class="c-calendar-container">
        </div>
       </div>
       <div class="d-month-view">
       </div>
       <div class="d-week-view">
       </div>
       <div class="d-day-view">
       </div>
       <div class="d-custom-range-view">
       </div>
      </tbody>
     </table>
     <button class="schedule-button" onclick="addScheduleRow()" type="button">
      Add Row
     </button>
     <button class="schedule-button" onclick="submitSchedule()" type="button">
      Submit
     </button>
     <button class="schedule-button" onclick="fetchSchedule()" type="button">
      Load Schedule
     </button>
    </form>
   </div>
   <div class="tab-content" id="settings">
    <form id="settingsForm">
     <div class="d-settings-row">
      <label for="wifi_ssid">
       Wi-Fi SSID:
      </label>
      <input id="wifi_ssid" name="wifi_ssid" required="" type="text"/>
     </div>
     <div class="d-settings-row">
      <label for="wifi_password">
       Wi-Fi Password:
      </label>
      <input id="wifi_password" name="wifi_password" type="text"/>
     </div>
     <div class="d-settings-row">
      <label for="remote_wifi_ssid">
       Remote Wi-Fi SSID:
      </label>
      <input id="remote_wifi_ssid" name="remote_wifi_ssid" type="text"/>
     </div>
     <div class="d-settings-row">
      <label for="remote_wifi_password">
       Remote Wi-Fi Password:
      </label>
      <input id="remote_wifi_password" name="remote_wifi_password" type="text"/>
     </div>
     <div class="d-settings-row">
      <label for="timezone">
       Timezone format:
      </label>
      <input id="timezone" name="timezone" type="text"/>
     </div>
     <div class="button-container">
      <button class="schedule-button" onclick="submitSettings()" type="button">
       Save Settings
      </button>
     </div>
    </form>
   </div>
  </div>
  <div class="d-popup" id="schedule-day-popup">
  </div>
  <script>
   function addScheduleRow(time = "", type = "single") {
    const table = document.getElementById("scheduleTable").getElementsByTagName("tbody")[0];
    const newRow = table.insertRow();
    newRow.innerHTML = `
        <td><input type="time" name="time[]" value="${time}" required class="form-time"></td>
        <td>
            <select name="type[]" required class="form-select">
                <option value="single" ${type == 1 ? "selected" : ""}>Single</option>
                <option value="double" ${type == 2 ? "selected" : ""}>Double</option>
                <option value="triple" ${type == 3 ? "selected" : ""}>Triple</option>
            </select>
        </td>
        <td><button type="button" onclick="deleteScheduleRow(this)" class="delete-button">x</button></td>
    `;
}

function deleteScheduleRow(button) {
    const row = button.parentNode.parentNode;
    row.parentNode.removeChild(row);

}



function showTab(tabId) {
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });

    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });

    document.querySelector(`.tab[onclick*="${tabId}"]`).classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

document.addEventListener("DOMContentLoaded", fetchSettings);
document.addEventListener("DOMContentLoaded", fetchSchedule);
document.addEventListener("DOMContentLoaded", updateTime);
  </script>
  <script>
   const calendarEl = document.getElementById('calendar');
const popupEl = document.getElementById('popup');
const popupContentEl = document.getElementById('popup-content');

const year = new Date().getFullYear();
const monthNames = ["January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"];
const weekdays = ["Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"];

function createCalendar(targetClass, year, showPopupFunc) {
    const calendarContainers = document.querySelectorAll(`.${targetClass}`);

    calendarContainers.forEach(calendarEl => {
        calendarEl.innerHTML = ''; // Clear previous content if any

        for (let month = 0; month < 12; month++) {
            const monthDiv = document.createElement('div');
            monthDiv.className = 'c-month';
            monthDiv.innerHTML = `<h3>${monthNames[month]}</h3>`;

            const daysGrid = document.createElement('div');
            daysGrid.className = 'c-days';

            weekdays.forEach(d => {
                const wd = document.createElement('div');
                wd.className = 'c-weekday';
                wd.textContent = d;
                daysGrid.appendChild(wd);
            });

            const firstDay = new Date(year, month, 0).getDay();
            const numDays = new Date(year, month + 1, 0).getDate();

            // empty slots before first day
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                daysGrid.appendChild(empty);
            }

            for (let day = 1; day <= numDays; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'c-day';
                dayEl.textContent = day;
                dayEl.addEventListener('click', () => showPopupFunc(`${year}-${month + 1}-${day}`));
                daysGrid.appendChild(dayEl);
            }

            monthDiv.appendChild(daysGrid);
            calendarEl.appendChild(monthDiv);
        }
    });
}

// function showPopup(dateString) {
//     popupContentEl.innerHTML = `<h2>Selected Date: ${dateString}</h2>
//         <p>You can add any custom UI or actions here, like forms, buttons, etc.</p>`;
//     popupEl.style.display = 'block';
// }

// function closePopup() {
//     popupEl.style.display = 'none';
// }
  </script>
  <script>
   class SchedulePoint {
    constructor(offset, action, duration) {
        this.offset = offset; // seconds from loop start
        this.action = action; // 'open' or 'close'
        this.duration = duration; // in seconds
    }
}

class Schedule {
    constructor(startTime = Date.now() / 1000, loopDuration = 86400) {
        this.startTime = Math.floor(startTime); // Unix timestamp in seconds
        this.loopDuration = loopDuration; // in seconds
        this.schedulePoints = []; // array of SchedulePoint
    }

    // Add a new schedule point
    addPoint(offset, action, duration) {
        if (!['open', 'close'].includes(action)) {
            throw new Error(`Invalid action "${action}". Must be 'open' or 'close'.`);
        }
        this.schedulePoints.push(new SchedulePoint(offset, action, duration));
    }

    // Update a point by index
    updatePoint(index, newOffset, newAction, newDuration) {
        if (index < 0 || index >= this.schedulePoints.length) return false;

        if (!['open', 'close'].includes(newAction)) return false;

        this.schedulePoints[index] = new SchedulePoint(newOffset, newAction, newDuration);
        return true;
    }

    // Delete a point by index
    deletePoint(index) {
        if (index < 0 || index >= this.schedulePoints.length) return false;
        this.schedulePoints.splice(index, 1);
        return true;
    }

    // Clear the entire schedule
    clear() {
        this.schedulePoints = [];
    }

    // Get the current offset within the loop
    getLoopTime(now = Date.now() / 1000) {
        return (Math.floor(now) - this.startTime) % this.loopDuration;
    }

    // Get active points at current time (could return multiple)
    getActivePoints(now = Date.now() / 1000) {
        const loopTime = this.getLoopTime(now);
        return this.schedulePoints.filter(pt => loopTime === pt.offset);
    }

    // Get serialized (JSON) schedule for storage or sending
    toJSON() {
        return {
            startTime: this.startTime,
            loopDuration: this.loopDuration,
            schedulePoints: this.schedulePoints.map(pt => ({
                offset: pt.offset,
                action: pt.action,
                duration: pt.duration
            }))
        };
    }

    // Load from JSON
    static fromJSON(json) {
        const schedule = new Schedule(json.startTime, json.loopDuration);
        json.schedulePoints.forEach(pt => {
            schedule.addPoint(pt.offset, pt.action, pt.duration);
        });
        return schedule;
    }
}

class ScheduleModel {
    constructor() {
        this.schedules = {
            yearly: new Schedule()
        };
        this.loopDuration = loopDuration; // in seconds
        this.schedulePoints = []; // array of SchedulePoint
    }

    static createYearlyLoop() {
        
    }
}
  </script>
  <script>
   createCalendar("c-calendar-container", year);
  </script>
 </body>
</html>
